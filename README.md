# OpenTofu + Ansible Integration Demo

A clean, minimal demonstration of using OpenTofu to provision infrastructure and Ansible to configure it, featuring a dynamic inventory script that bridges the two tools.

## What This Demo Does

1. **OpenTofu** deploys an EC2 instance in AWS
2. **Python script** reads OpenTofu state and generates dynamic Ansible inventory
3. **Ansible** configures the instance with a Hello World web server

## Prerequisites

- [OpenTofu](https://opentofu.org/docs/intro/install/) installed
- [Ansible](https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html) installed
- Python 3.x
- AWS account with credentials configured
- SSH client

## AWS Authentication Setup

Before running this demo, ensure your AWS credentials are configured. You can do this in several ways:

### Option 1: AWS CLI Configuration (Recommended)
```bash
aws configure
```

### Option 2: Environment Variables
```bash
export AWS_ACCESS_KEY_ID="your-access-key"
export AWS_SECRET_ACCESS_KEY="your-secret-key"
export AWS_DEFAULT_REGION="us-east-1"
```

### Option 3: AWS Profile
```bash
export AWS_PROFILE="your-profile-name"
```

Verify your authentication:
```bash
aws sts get-caller-identity
```

## SSH Key Setup

Create an SSH key pair for the EC2 instance:

```bash
ssh-keygen -t rsa -b 4096 -f demo-key -N ""
```

This creates two files:
- `demo-key` - Private key (used by Ansible to connect)
- `demo-key.pub` - Public key (uploaded to AWS by OpenTofu)

## Quick Start

### 1. Initialize OpenTofu
```bash
tofu init
```

### 2. Deploy Infrastructure
```bash
tofu apply
```

Review the planned changes and type `yes` to confirm. OpenTofu will:
- Create a security group allowing SSH (port 22) and HTTP (port 80)
- Upload your SSH public key
- Launch an EC2 instance (t2.micro with Amazon Linux 2023)

### 3. Verify the Dynamic Inventory
```bash
./inventory/dynamic_inventory.py --list
```

This should display JSON output with your instance's public IP.

You can also test the Ansible inventory:
```bash
ansible-inventory --list
```

### 4. Configure the Server with Ansible
```bash
ansible-playbook playbook.yml
```

Ansible will:
- Install Python 3
- Create a Hello World HTML page
- Set up a systemd service running a web server on port 80

### 5. Access Your Web Server

The playbook will display the URL at the end, or get the IP from OpenTofu:
```bash
tofu output instance_public_ip
```

Open the URL in your browser:
```
http://<instance_public_ip>
```

You should see a styled "Hello World!" page confirming the deployment.

## How It Works

### OpenTofu → Ansible Handoff

The magic happens in `inventory/dynamic_inventory.py`:

1. **Reads OpenTofu state** using `tofu output -json`
2. **Extracts outputs** like instance IP, SSH user
3. **Generates Ansible inventory** in JSON format
4. **Provides connection details** for Ansible to use

This dynamic approach means:
- No manual inventory updates needed
- Infrastructure and configuration stay in sync
- Easy to scale to multiple instances

### File Structure

```
.
├── main.tf                         # OpenTofu main configuration
├── variables.tf                    # Input variables
├── outputs.tf                      # Outputs for Ansible
├── ansible.cfg                     # Ansible configuration
├── playbook.yml                    # Ansible playbook
├── inventory/
│   └── dynamic_inventory.py        # Dynamic inventory script
├── demo-key                        # SSH private key (generated by you)
├── demo-key.pub                    # SSH public key (generated by you)
└── README.md                       # This file
```

## Customization

### Change AWS Region
Edit `variables.tf` or use:
```bash
tofu apply -var="aws_region=us-west-2"
```

### Change Instance Type
Edit `variables.tf` or use:
```bash
tofu apply -var="instance_type=t2.small"
```

### Use Different SSH Key
```bash
tofu apply -var="ssh_public_key_path=/path/to/your/key.pub"
```

Update `inventory/dynamic_inventory.py` line 62 to match your private key path.

## Cleanup

Destroy all AWS resources:
```bash
tofu destroy
```

Type `yes` to confirm. This removes:
- EC2 instance
- Security group
- SSH key pair from AWS

Your local SSH keys (`demo-key` and `demo-key.pub`) are not deleted automatically.

## Troubleshooting

### Can't connect to instance
- Wait 30-60 seconds after `tofu apply` for the instance to fully boot
- Verify security group allows your IP: check AWS Console
- Ensure SSH key permissions: `chmod 600 demo-key`

### Dynamic inventory returns empty
- Run `tofu output` to verify outputs exist
- Check that OpenTofu state file exists: `ls terraform.tfstate`

### Ansible connection timeout
- Verify the instance is running: `aws ec2 describe-instances`
- Check you can SSH manually: `ssh -i demo-key ec2-user@<ip>`
- Ensure security group allows SSH from your IP

### Web server not accessible
- Verify the service is running: `ansible web_servers -m shell -a "systemctl status hello-web"`
- Check security group allows HTTP (port 80)
- Ensure you're using HTTP not HTTPS

## Learning Points

This demo showcases:
- **Infrastructure as Code** with OpenTofu
- **Configuration Management** with Ansible
- **Dynamic Inventory** bridging IaC and CM tools
- **Minimal configuration** for clarity and learning
- **Local state** for simplicity (use remote state in production)

## Next Steps

To extend this demo:
- Add multiple instances and configure load balancing
- Use OpenTofu remote state (S3 + DynamoDB)
- Implement Ansible roles for better organization
- Add monitoring and logging
- Deploy a real application instead of Hello World

## License

This demo is provided as-is for educational purposes.